# Tomcat 8 优化

------

JVM内存模型
![jvm-04.png](https://aaron-13.github.io/images/jvm-04.png)

为了垃圾回收使用，堆内存中又区分新生代，老年代
![jvm-05.png](https://aaron-13.github.io/images/jvm-05.png)

运行生成的对象实例都存储在Eden中。垃圾回收时，将Eden中存活的对象和幸存区From中的存活对象复制到幸存区的To，然后清空Eden和From，此时From和To角色互换，当有的存活对象在From和To中折腾次数多了，达到一个阈值，就放到Old老年代里面，以后不删除了。
Permanent永久代:是指内存的永久保存区域，主要存放Class和Meta信息，GC不会在主程序运行期间对Permanent进行清理

![jvm-06.png](https://aaron-13.github.io/images/jvm-06.png)

常见错误:
+ 堆内存不足: Java heap space
+ 方法区内存不足(永久代): PermGen space
+ 虚拟机栈和本地方法栈溢出: java.lang.StackOverflowError

JVM内存相关配置:
+ -Xms 初始堆内存，-Xms2G等价于 -XX:InitialHeapSize=2G
+ -XmX 最大堆内存，-Xmx2G等价于 -XX:MaxHeapSize=2G,最好两者设置一样，减少申请内存的消耗
+ -XX:MaxNewSize  设置新生代最大大小
+ -XX:NewRatio 设置老年代与新生代的比例，优点是新生代会随着整个堆大小动态扩展，如-XX：NewRatio=3，表示老年代/新生代为3/1
+ -XX:SurvivorRatio Eden与幸存区大小比例,如-XX:SurvivorRatio=10表示Eden是幸存区TO/From的10倍，两个幸存区一样大
+ -XX:PermSize 永久代初始大小
+ -XX:MaxPermSize 永久代最大值
+ -Xss 设置每个线程的堆栈大小。在相同物理内存下，减少这个值能生成更多的线程。如果设置过小，可能出现栈溢出，如果过大，会影响创建栈的数量，如果是多线程的应用，就会出现内存溢出
+ -XX:+UseCodeCacheFlushing: 但代码缓存被填满时，让JVM放弃一些编译代码
+ -XX: +HeapDumpOnOutOfMemoryError: 让JVM在发生内存溢出时自动的生成堆内存快照，默认保存在启动目录下名为java_pid<pid>.hprof的文件里
+ -XX:HeapDumpPath=<path>: 让JVM在发生内存溢出时自动的生成堆内存快照的路径
+ -XX:OnOutOfMemoryError: 当内存溢出时，可以指定一些指令，如 -XX:OnOutOfMemoryError = "sh ./cleanup.sh"
+ -XX:+printCommandLineFlags: 打印修改过的参数
+ -XX:InitialCodeCacheSize: 代码缓存，用来存储一边以方法生成的本地代码，如代码缓存被沾满，JVM打印警告信息，并切换到interpreted-only模式，JIT编译器被停用，字节码不会再变异成机器码。

